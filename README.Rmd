---
output: 
   github_document
  # word_document
title: 'Road traffic fatalities by light conditions: a comparative analysis between the US and the UK'
always_allow_html: true
bibliography: saturn.bib
---

# Introduction

The number of pedestrian fatalities in the United States has risen steadily since 2009 [@sanders_pedestrian_2022; @ferenchak_shedding_2022; @wang_fatal_2020].
A key risk factor in these pedestrian deaths is darkness [@ferenchak_shedding_2022; @sanders_pedestrian_2022].
Despite less pedestrian flow at night, three-quarters of pedestrian fatalities in the US occur in the dark.
Also, the rate of pedestrian deaths in the dark in the US is increasing. 

<!-- Speed limits, number of lanes, roadway type, and presence of traffic control were found significantly associated with the likelihood of a pedestrian fatality occurring in darkness as compared to daylight. Alcohol usage by drivers or pedestrians and sociodemographic characteristics were also positively associated with fatal injuries in darkness [@sanders_pedestrian_2022]. -->

Several questions arise:

- Is the number of fatality cyclists increasing as much as the number of pedestrians? And how does the darkness influence fatality in cyclists?

- Is the increase in pedestrian fatalities and darkness a trend unique to the US or is it also happening in other Western countries like the United Kingdom? 

Using road safety data and travel data from the US and UK, this study estimates and compares trends in the risk of travelling in the dark by modes of transport (pedestrians, cyclists, and other road users) between the US and the UK. 

<!-- The study also examines correlates that explain the higher fatality rate at night in the UK. -->

# Data and method

## Data

#### Road safety data

- US Fatality Analysis Reporting System (FARS) data -- National Highway Traffic Safety Administration (NHTSA) 
- UK Road Safety Data (STATS19) -- Department for Transport (DfT) 

#### Travel data

- US National Household Travel Survey -- Federal Highway Administration (FHWA)
- UK National Travel Survey -- DfT

## Method

$$ \text{Risk ratio (dark)} = \text{num. fatalities (dark)}/\text{Bkm travelled (dark)}$$

# Results

## Road traffic fatalities by light conditions and type

```{r include=FALSE}
knitr::opts_chunk$set(cache = TRUE, cache.lazy = FALSE) 
library(tidyverse)
library(ggpubr)
library(piggyback)
library(kableExtra)
```

```{r include=FALSE}
remotes::install_github("elipousson/crashapi")
```

```{r include=FALSE, eval=FALSE}
crashes = crashapi::get_fars(year = 2020, state = "MD", county = "Anne Arundel County", details = TRUE)
# dir.create("example-data")
# dir.create("example-data/fars")
crashes %>% 
  slice(1:10) %>% 
  write_csv(file = "data/example-data/fars/fars_example_md_top_10.csv")
crashes %>% 
  write_csv("data/crashes_fars_2020_md_anne_arundel_county.csv")
piggyback::pb_release_create(tag = "1")
piggyback::pb_upload("data/crashes_fars_2020_md_anne_arundel_county.csv", tag = "1")
```

```{r eval=FALSE, include=FALSE}
# Get travel survey data
nhts17_tripub <- read.csv("data/NHTS/trippub.csv")
names(nhts17_tripub)
table(nhts17_tripub$STRTTIME)
table(nhts17_tripub$ENDTIME)
table(nhts17_tripub$TDAYDATE)
table(nhts17_tripub$TRPMILES)
table(nhts17_tripub$TRVLCMIN)
table(nhts17_tripub$TRPTRANS) # 01 walk, 02 bicycle, 03 Car, 04 SUV

# Mutate daylight/dark variable 
# https://www.rdocumentation.org/packages/StreamMetabolism/versions/1.1.2/topics/sunrise.set
# https://www.r-bloggers.com/2014/09/seeing-the-daylight-with-r/

# Estimate vkm by daylight/dark
```

### US 2011-2020 (FARS data)

```{r include=FALSE}
# get data from https://www.nhtsa.gov/research-data/fatality-analysis-reporting-system-fars

year_range <- c(2011:2020)

# Download ZIP files with FARS data
purrr::walk(
  year_range,
  function(x) {
    crashapi::get_fars_zip(
      year = x, format = "csv",
      path = here::here("data"), read = FALSE
    )
    
    # Download unzip data files (each year in a different folder)
    unzip(here::here("data", glue::glue("FARS{x}NationalCSV.zip")),
          exdir = glue::glue("data/FARS{x}")
    )
  }
)


fars <- 
  purrr::map_dfr(
  year_range,
  function(x) {
    path <- paste0("data/FARS", x)

    file <-
      fs::dir_ls(
        path = paste0("data/FARS", x),
        regexp = "accident|ACCIDENT"
      )

    readr::read_csv(file) |>
      dplyr::select(
        dplyr::any_of(
          c("ST_CASE", "COUNTY", "STATE", "YEAR", "MONTH", "DAY", "HOUR", "MINUTE", "HARM_EV", "LGT_COND")
        )
      )
  }
)

purrr::walk(
  year_range,
  function(x) {
    # Download auxiliary ZIP files with FARS data
    crashapi::get_fars_zip(
      year = x, format = "csv",
      aux = TRUE,
      path = here::here("data"), read = FALSE
    )

    # Unzip the data
    unzip(here::here("data", glue::glue("FARS{x}NationalAuxiliaryCSV.zip")),
      exdir = here::here(glue::glue("data/FARS{x}_Aux"))
    )
  }
)

fars_aux <- purrr::map_dfr(
  year_range,
  function(x) {
    # Read and join the auxiliary crash and person files
    dplyr::left_join(
      readr::read_csv(here::here("data", paste0("FARS", x, "_Aux"), "ACC_AUX.CSV")),
      readr::read_csv(here::here("data", paste0("FARS", x, "_Aux"), "PER_AUX.CSV"))
    )
  }
)

fars_combined <-
  dplyr::left_join(
    fars,
    fars_aux
  )

readr::write_csv(fars_combined, here::here("output", "fars.csv"))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(dplyr)
library(ggplot2)


fips <- crashapi:::fips_state_table |> 
  transmute(
    STATE = as.integer(fips),
    state_name = stringr::str_to_title(name)
  )

fars <- readr::read_csv(here::here("output", "fars.csv"))

fars_select <- fars |> 
  select(
    STATE, YEAR, LGT_COND, A_PERINJ, A_PTYPE
  ) |> 
  mutate(
    light_condition = case_when(
      LGT_COND == 1 ~ "Daylight",
      LGT_COND == 2 ~ "Dark – Not Lighted",
      LGT_COND == 3 ~ "Dark – Lighted",
      LGT_COND == 4 ~ "Dawn",
      LGT_COND == 5 ~ "Dusk",
      LGT_COND == 6 ~ "Dark – Unknown Lighting",
      LGT_COND == 7 ~ "Other",
      LGT_COND == 8 ~ "Not Reported",
      LGT_COND == 9 ~ "Unknown"
    ),
    person_type = case_when(
      A_PTYPE == 1 ~ "Driver",
      A_PTYPE == 2 ~ "Occupant",
      A_PTYPE == 3 ~ "Pedestrian",
      A_PTYPE == 4 ~ "Pedalcyclist",
      A_PTYPE == 5 ~ "Other/Unknown Non-Occupants"
  ),
  injury_type = case_when(
    A_PERINJ == 1 ~ "Fatal",
    A_PERINJ == 6 ~ "Survivor in Fatal Crash"
  ),
  YEAR = as.Date(paste0(YEAR, "-01-01"))
  ) |> 
  left_join(fips) |> 
  janitor::clean_names()
  

fatal_light_condition <- fars_select |> 
  filter(
    injury_type == "Fatal",
    !(light_condition %in% c("Unknown", "Not Reported"))
  ) |> 
  mutate(
    light_condition = forcats::fct_collapse(
      light_condition,
      "Light" = "Daylight",
      "Dark" = c("Dark – Not Lighted", "Dark – Lighted", "Dark – Unknown Lighting"),
      "Other" = c("Dawn", "Dusk", "Other")
    )
  )

fatal_light_condition_state_pct <- fatal_light_condition |> 
  count(year, state_name, person_type, light_condition, name = "count") |> 
  left_join(count(fatal_light_condition, year, state_name, person_type, name = "type_count")) |> 
  mutate(
    pct_count = count / type_count
  )

fatal_light_condition_state_pct |> 
  filter(
    light_condition == "Dark"#,
    # state_name == "California"
  ) |> 
  ggplot(aes(year, pct_count, color = person_type)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  facet_wrap(~ person_type) +
  guides(color = "none") +
  cols4all::scale_color_discrete_c4a_cat(palette = "tol.vibrant") +
  labs(
    title = "Share of fatal crashes for each state in dark light conditions by person type"
  )

fatal_light_condition_pct <- fatal_light_condition |> 
  count(year, person_type, light_condition, name = "count") |> 
  left_join(count(fatal_light_condition, year, person_type, name = "type_count")) |> 
  mutate(
    pct_count = count / type_count
  )

labs_x_yr <- function(...) {
  list(
    scale_x_date(),
    ggplot2::labs(
      ...,
      x = "Year",
      caption = "Source: NHTSA FARS, 2011-2020"
    )
  )
}

fatal_light_condition_pct |> 
  filter(
    light_condition == "Dark"
    ) |> 
  ggplot(aes(year, pct_count, color = person_type)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  facet_wrap(~ person_type) +
  guides(color = "none") +
  cols4all::scale_color_discrete_c4a_cat(palette = "tol.vibrant") +
  scale_y_continuous(labels = scales::label_percent()) +
  labs_x_yr(
    y = "% of fatal crashes in dark light conditions",
    color = "Person type"
  )

fars_select |> 
  count(year, person_type) |> 
  ggplot(aes(year, n, color = person_type)) +
  ggshadow::geom_shadowline(size = 1.25) +
  ggshadow::geom_shadowpoint(size = 1.75) +
  cols4all::scale_color_discrete_c4a_cat(palette = "tol.vibrant") +
  scale_y_log10() +
  facet_wrap(~ person_type) +
  theme_light() +
  labs_x_yr(
    y = "Fatal crashes (#)",
    color = "Person type"
  )
```

Table 1. Road traffic fatalities by light conditions and type, US 2011-2020

```{r message=FALSE, warning=FALSE, include=FALSE}
fars = read_csv("data/FARS/NHTSA_peracc11_20.csv")
# Sanity check - compare data with US general results - All good!
# fars %>% 
#   filter(PBPTYPE == 5 & A_PERINJ == 1) %>% 
#   group_by(YEAR) %>% 
#   summarise(n=n())
```

```{r tab1, echo=FALSE, message=FALSE, warning=FALSE}
data_table <- fars %>% 
  select(A_PTYPE, YEAR, LGT_COND, A_PERINJ, `Light conditions in detail` = LGT_CONDNAME) %>% 
  mutate(`Light conditions in detail` = factor(`Light conditions in detail`, levels = c("Daylight", "Dark - Lighted", "Dark - Not Lighted", "Dark - Unknown Lighting", "Dawn", "Dusk"))) %>% 
  mutate(Type = ifelse(A_PTYPE == 3, "Pedestrians", ifelse(A_PTYPE == 4, "Cyclists", "Others"))) %>%
  mutate(Type = factor(Type, levels = c("Pedestrians", "Cyclists", "Others"))) %>%
  filter(A_PERINJ == 1 & `Light conditions in detail` != "Unkown") %>%
    group_by(Type, `Light conditions in detail`) %>% 
  summarise(`Num.` = n()) %>% 
  mutate(`%` = round(`Num.`/sum(`Num.`)*100, 2)) %>%
  mutate(`Light conditions` = ifelse(`Light conditions in detail` == "Daylight", "Daylight", "Dark")) %>% 
  select(Type, `Light conditions`, `Light conditions in detail`, `Num.`, `%`)

kable(data_table, format = "pipe")%>%
  kable_paper("striped", full_width = F) %>%
  pack_rows("", 1, 6) %>%
  pack_rows("", 7, 12) %>%
  pack_rows("", 13, 18)
```


```{r fig1, echo=FALSE, message=FALSE, warning=FALSE}
pal <- c("#EBCC2A", "#78B7C5")

data_plots = fars %>% 
  select(A_PTYPE, YEAR, A_PERINJ) %>% 
  mutate(Type = ifelse(A_PTYPE == 3, "Pedestrians", ifelse(A_PTYPE == 4, "Cyclists", "Others"))) %>%
  filter(A_PERINJ == 1) %>%
  group_by(YEAR, Type) %>% 
  summarise(n = n()) %>% 
  mutate(perc = n/sum(n)*100) 
  
data_plots$YEAR = as.factor(data_plots$YEAR)

p1_us = data_plots %>% 
  filter(Type == "Pedestrians") %>% 
  ggplot(aes(x = YEAR, y = n, group = 1)) +
  geom_line() + 
  geom_point() +
  labs(title = "Pedestrians",
       x = "", 
       y = "Num. of fatalities") +
  theme_minimal() 

p2_us = data_plots %>% 
  filter(Type == "Cyclists") %>% 
  ggplot(aes(x = YEAR, y = n, group = 1)) +
  geom_line() + 
  geom_point() +
  labs(title = "Cyclists",
       x = "", 
       y = "Num. of fatalities") +
  theme_minimal() 

p3_us = data_plots %>%
  filter(Type == "Others") %>%
  ggplot(aes(x = YEAR, y = n, group = 1)) +
  geom_line() + 
  geom_point() +
  labs(title = "Others",
       x = "", 
       y = "Num. of fatalities") +
  theme_minimal() 

ggarrange(p1_us, p2_us, p3_us,
          common.legend = TRUE, legend = "right",
          ncol = 1, nrow = 3)
```

Figure 1. Road traffic fatalities by year and type, US 2011-2020

```{r fig2, echo=FALSE, message=FALSE, warning=FALSE}
data_plots = fars %>% 
  select(A_PTYPE, YEAR, LGT_COND, A_PERINJ) %>% 
  mutate(`Light conditions` = ifelse(LGT_COND == 1, "Daylight", ifelse(LGT_COND >= 1 & LGT_COND <= 6, "Dark", "Unkown"))) %>% 
  mutate(`Light conditions` = factor(`Light conditions`, levels = c("Daylight", "Dark", "Unkown"), labels = c("Daylight", "Dark", "Unkown"))) %>% 
  mutate(Type = ifelse(A_PTYPE == 3, "Pedestrians", ifelse(A_PTYPE == 4, "Cyclists", "Others"))) %>%
  filter(A_PERINJ == 1, `Light conditions` != "Unkown") %>%
  group_by(YEAR, Type, `Light conditions`) %>% 
  summarise(n = n()) %>% 
  mutate(perc = n/sum(n)*100)

data_plots$YEAR = as.factor(data_plots$YEAR)

p4_us = data_plots %>% 
  filter(Type == "Pedestrians") %>% 
  ggplot() +
  geom_col(aes(YEAR, y = perc, fill = `Light conditions`, colour = `Light conditions`), position = "dodge", alpha = 0.7) + 
  labs(title = "Pedestrians",
       x = "", 
       y = "% of fatalities", 
       color = "Light conditions") +
  scale_fill_manual(values = pal) +
  scale_colour_manual(values = pal) +
  theme_minimal()

p5_us = data_plots %>% 
  filter(Type == "Cyclists") %>% 
  ggplot() +
  geom_col(aes(YEAR, y = perc, fill = `Light conditions`, colour = `Light conditions`), position = "dodge", alpha = 0.7) + 
  labs(title = "Cyclists",
       x = "", 
       y = "% of fatalities") +
  scale_fill_manual(values = pal) +
  scale_colour_manual(values = pal) +
  theme_minimal()

p6_us = data_plots %>%
  filter(Type == "Others") %>%
  ggplot() +
  geom_col(aes(YEAR, y = perc, fill = `Light conditions`, colour = `Light conditions`), position = "dodge", alpha = 0.7) + 
  labs(title = "Others",
       x = "", 
       y = "% of fatalities") +
  scale_fill_manual(values = pal) +
  scale_colour_manual(values = pal) +
  theme_minimal()

ggarrange(p4_us, p5_us, p6_us,
          common.legend = TRUE, legend = "right",
          ncol = 1, nrow = 3)
```

Figure 2. % of road traffic fatalities by light conditions, year, and type, US 2011-2020 

### UK 2011-2020 (STATS19 data)

```{r eval=FALSE, include=FALSE}
library(stats19)
# merge
accidents1979_2021_raw = read_csv("data/STATS19/dft-road-casualty-statistics-accident-1979-2021.csv")
vehicles1979_2021_raw = read_csv("data/STATS19/dft-road-casualty-statistics-vehicle-1979-2021.csv")
casualties1979_2021_raw = read_csv("data/STATS19/dft-road-casualty-statistics-casualty-1979-2021.csv")

accidents1979_2021 = format_accidents(accidents1979_2021_raw)
vehicles1979_2021 = format_vehicles(vehicles1979_2021_raw)
casualties1979_2021 = format_casualties(casualties1979_2021_raw)

# merge
va79_21 <- left_join(vehicles1979_2021, accidents1979_2021)
cva79_21 <- left_join(va79_21, casualties1979_2021)

# save
cva79_21 %>% 
  select(casualty_type, accident_year, casualty_severity, light_conditions) %>% 
  filter(accident_year > 2010 & accident_year < 2021) %>% 
  write_csv("data/STATS19/cva11_20.csv")
```

Table 2. Road traffic fatalities by light conditions and type, UK 2011-2020

```{r message=FALSE, warning=FALSE, include=FALSE}
cva11_20 = read_csv("data/STATS19/cva11_20.csv")
```

```{r tab2, echo=FALSE, message=FALSE, warning=FALSE}
data_table <- cva11_20%>% 
  select(casualty_type, YEAR = accident_year, casualty_severity, `Light conditions in detail` = light_conditions) %>% 
  mutate(`Light conditions in detail` = factor(`Light conditions in detail`, levels = c("Daylight", "Darkness - lights lit", "Darkness - lights unlit", "Darkness - no lighting", "Darkness - lighting unknown", "Data missing or out of range"))) %>%
  mutate(Type = ifelse(casualty_type == "Pedestrian", "Pedestrians", ifelse(casualty_type == "Cyclist", "Cyclists", "Others"))) %>%
  mutate(Type = factor(Type, levels = c("Pedestrians", "Cyclists", "Others"))) %>% # Criteria on Motorised vehicles occupants category is not the same in the UK and US. Explain in method
  filter(casualty_severity == "Fatal" & `Light conditions in detail` != "Data missing or out of range") %>%
    group_by(Type, `Light conditions in detail`) %>% 
  summarise(`Num.` = n()) %>% 
  mutate(`%` = round(`Num.`/(sum(`Num.`))*100,2))  %>%
  mutate(`Light conditions` = ifelse(`Light conditions in detail` == "Daylight", "Daylight", "Dark")) %>% 
  select(Type, `Light conditions`, `Light conditions in detail`, `Num.`, `%`)

kable(data_table, format = "pipe") %>%
  kable_paper("striped", full_width = F) %>%
  pack_rows("", 1, 5) %>%
  pack_rows("", 6, 10) %>%
  pack_rows("", 11, 15)
```

```{r echo=FALSE}
data_plots <- cva11_20%>% 
  select(casualty_type, YEAR = accident_year, casualty_severity) %>% 
  mutate(Type = ifelse(casualty_type == "Pedestrian", "Pedestrians", ifelse(casualty_type == "Cyclist", "Cyclists", ifelse(casualty_type == "Horse rider", "Others", "Motorised vehicles occupants")))) %>%
  mutate(Type = factor(Type, levels = c("Pedestrians", "Cyclists", "Motorised vehicles occupants"))) %>%
  filter(casualty_severity == "Fatal" & Type != "Others") %>%
  group_by(YEAR, Type) %>% 
  summarise(n = n())

data_plots$YEAR = as.factor(data_plots$YEAR)

p1_uk = data_plots %>% 
  filter(Type == "Pedestrians") %>% 
  ggplot(aes(x= YEAR, y = n, group = 1)) +
  geom_line() + 
  geom_point() +
  labs(title="Pedestrians",
       x ="", 
       y = "Num. of fatalities") +
  theme_minimal()  

p2_uk = data_plots %>% 
  filter(Type == "Cyclists") %>% 
  ggplot(aes(x= YEAR, y = n, group = 1)) +
  geom_line() + 
  geom_point() +
  labs(title="Cyclists",
       x ="", 
       y = "Num. of fatalities") +
  theme_minimal()

p3_uk = data_plots %>%
  filter(Type == "Motorised vehicles occupants") %>%
  ggplot(aes(x= YEAR, y = n, group = 1)) +
  geom_line() + 
  geom_point() +
  labs(title="Others",
       x ="", 
       y = "Num. of fatalities") +
  theme_minimal()

ggarrange(p1_uk, p2_uk, p3_uk,
          common.legend = TRUE, legend = "right",
          ncol = 1, nrow = 3)
```

Figure 3. Road traffic fatalities by year and type, UK 2011-2020

```{r echo=FALSE}
data_plots <- cva11_20%>% 
  select(casualty_type, YEAR = accident_year, casualty_severity, `Light conditions in detail` = light_conditions) %>% 
  mutate(`Light conditions` = ifelse(`Light conditions in detail` == "Darkness - lights lit" | `Light conditions in detail` == "Darkness - lights unlit" | `Light conditions in detail` == "Darkness - no lighting" | `Light conditions in detail` == "Darkness - lighting unknown", "Dark", ifelse(`Light conditions in detail` == "Data missing or out of range", "NA", "Daylight"))) %>%
 mutate(`Light conditions` = factor(`Light conditions`, levels = c("Daylight", "Dark"), labels = c("Daylight", "Dark"))) %>% 
  mutate(Type = ifelse(casualty_type == "Pedestrian", "Pedestrians", ifelse(casualty_type == "Cyclist", "Cyclists", ifelse(casualty_type == "Horse rider", "Others", "Motorised vehicles occupants")))) %>%
  mutate(Type = factor(Type, levels = c("Pedestrians", "Cyclists", "Motorised vehicles occupants"))) %>%
  filter(casualty_severity == "Fatal" & Type != "Others" & `Light conditions in detail` != "Data missing or out of range") %>%
  group_by(YEAR, Type, `Light conditions`) %>% 
  summarise(n = n()) %>% 
  mutate(perc = round(n/(sum(n))*100,2))

data_plots$YEAR = as.factor(data_plots$YEAR)

p4_uk = data_plots %>% 
  filter(Type == "Pedestrians") %>% 
  ggplot() +
  geom_col(aes(YEAR, y = perc, fill = `Light conditions`, colour = `Light conditions`), position = "dodge", alpha = 0.7) + 
  labs(title="Pedestrians",
       x ="", 
       y = "% of fatalities", 
       color = "Light conditions") +
  scale_fill_manual(values = pal) +
  scale_colour_manual(values = pal) +
  theme_minimal()

p5_uk = data_plots %>% 
  filter(Type == "Cyclists") %>% 
  ggplot() +
  geom_col(aes(YEAR, y = perc, fill = `Light conditions`, colour = `Light conditions`), position = "dodge", alpha = 0.7) + 
  labs(title="Cyclists",
       x ="", 
       y = "% of fatalities") +
  scale_fill_manual(values = pal) +
  scale_colour_manual(values = pal) +
  theme_minimal()

p6_uk = data_plots %>%
  filter(Type == "Motorised vehicles occupants") %>%
  ggplot() +
  geom_col(aes(YEAR, y = perc, fill = `Light conditions`, colour = `Light conditions`), position = "dodge", alpha = 0.7) + 
  labs(title="Others",
       x ="", 
       y = "% of fatalities") +
  scale_fill_manual(values = pal) +
  scale_colour_manual(values = pal) +
  theme_minimal()

ggarrange(p4_uk, p5_uk, p6_uk,
          common.legend = TRUE, legend = "right",
          ncol = 1, nrow = 3)
```

Figure 4. UK % of road traffic fatalities by light conditions, year, and type, UK 2011-2020

# Dicusssion

# Conclusions

# References
